package org.example.helofy.controllers;

import com.fasterxml.jackson.databind.ObjectMapper;
import javafx.animation.Animation;
import javafx.animation.TranslateTransition;
import javafx.application.Platform;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.OverrunStyle;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.HBox;
import javafx.scene.layout.StackPane;
import javafx.scene.shape.Rectangle;
import javafx.stage.Stage;
import javafx.util.Duration;
import org.example.helofy.model.Playlist;
import org.example.helofy.model.RutaUsuario;
import org.example.helofy.model.Song;
import org.example.helofy.model.Usuario;
import org.example.helofy.utils.MusicPlayer;
import org.example.helofy.utils.Rounded;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Objects;

public class HelofyMainController {

    @FXML
    private StackPane contentArea;
    @FXML
    private Slider volumeSlider;
    @FXML
    private Button playPauseButton;
    @FXML
    private Button previousButton;
    @FXML
    private Button nextButton;
    @FXML
    private Slider progressSlider;
    @FXML
    private Label songName;
    @FXML
    private Label songArtist;
    @FXML
    private ImageView songImage;
    @FXML
    private Button shuffleButton;
    @FXML
    private ImageView headerImage;
    @FXML
    private ImageView imagenBienvenida;
    @FXML
    private Button createPlaylistButton;
    @FXML
    private Label lblTiempoTranscurrido;
    @FXML
    private Label lblTiempoRestante;
    @FXML
    private StackPane songNameContainer;
    @FXML
    private ImageView userImage;
    @FXML
    private Button userButton;
    @FXML
    private Button ExitButton;
    @FXML
    private HBox header;

    @FXML
    private ListView<String> playlistListViewFavorites;

    private final MusicPlayer musicPlayer = new MusicPlayer();
    private boolean isDraggingProgress = false;
    private double duracionTotalSegundos = 0;
    private TranslateTransition marqueeAnimation;

    private double xOffset = 0;
    private double yOffset = 0;

    @FXML
    public void initialize() {

        inicializarListaFavoritas();

        header.setOnMousePressed(event -> {
            xOffset = event.getSceneX();
            yOffset = event.getSceneY();
        });

        header.setOnMouseDragged(event -> {
            Stage stage = (Stage) header.getScene().getWindow();
            stage.setX(event.getScreenX() - xOffset);
            stage.setY(event.getScreenY() - yOffset);
        });
        configureMusicPlayer();
        setupControls();
        setupVolumePersistente();

        headerImage.setImage(new Image(getClass().getResource("/org/example/helofy/styles/logoapp2.png").toExternalForm()));
        Rounded.applyRoundedClip(headerImage, 15.0);

        imagenBienvenida.setImage(new Image(getClass().getResource("/org/example/helofy/styles/welcome.png").toExternalForm()));
        imagenBienvenida.setPreserveRatio(true);

        System.out.println("Inicializando controlador...");

        Usuario usuario = cargarUsuario();
        if (usuario != null) {
            System.out.println("Usuario cargado: " + usuario.getNombre());
            userButton.setText(usuario.getNombre());
            userImage.setImage(cargarImagenUsuario(usuario.getImagenPath()));
        } else {
            System.out.println("No se encontró usuario");
            userButton.setText("Usuario");
            userImage.setImage(new Image(getClass().getResource("/org/example/helofy/styles/defaultImage.png").toExternalForm()));
        }
        Rounded.applyRoundedClip(userImage, 10.0);
    }




    private void inicializarListaFavoritas() {
        playlistListViewFavorites.getItems().addAll("Lista 1", "Lista 2", "Lista 3");

        playlistListViewFavorites.setCellFactory(list -> new ListCell<>() {
            private final Button button = new Button();

            {
                button.getStyleClass().add("menu-button");
                button.setMaxWidth(Double.MAX_VALUE);
            }

            @Override
            protected void updateItem(String item, boolean empty) {
                super.updateItem(item, empty);
                if (empty || item == null) {
                    setGraphic(null);
                } else {
                    button.setText(item);
                    setGraphic(button);
                }
            }
        });
    }
    private Usuario cargarUsuario() {
        try {
            Path path = RutaUsuario.JSON_USUARIO;
            System.out.println("Ruta usuario: " + path.toAbsolutePath());

            if (!Files.exists(path)) {
                System.out.println("No existe el JSON, abriendo registro");
                FXMLLoader loader = new FXMLLoader(getClass().getResource("/org/example/helofy/views/usuario/RegistroUsuario.fxml"));
                Parent registroRoot = loader.load();
                Stage stage = new Stage();
                stage.setScene(new Scene(registroRoot));
                stage.setTitle("Registro de Usuario");
                stage.setResizable(false);
                stage.show();

                Stage actual = (Stage) userButton.getScene().getWindow();
                actual.close();

                return null;
            }

            System.out.println("Archivo usuario existe, leyendo...");
            ObjectMapper mapper = new ObjectMapper();
            Usuario usuario = mapper.readValue(path.toFile(), Usuario.class);
            System.out.println("Usuario cargado: " + usuario.getNombre());
            return usuario;

        } catch (Exception e) {
            System.err.println("Error cargando usuario: " + e.getMessage());
            e.printStackTrace();
            return null;
        }
    }


    private Image cargarImagenUsuario(String path) {
        if (path != null && !path.isBlank()) {
            File archivo = new File(path);
            if (archivo.exists()) {
                return new Image(archivo.toURI().toString());
            }
        }
        return new Image(getClass().getResource("/org/example/helofy/styles/defaultImage.png").toExternalForm());
    }

    public void actualizarUsuario(Usuario usuario) {
        userButton.setText(usuario.getNombre());
        if (usuario.getImagenPath() != null && !usuario.getImagenPath().isBlank()) {
            userImage.setImage(new Image("file:" + usuario.getImagenPath(), false));
        } else {
            userImage.setImage(new Image(getClass().getResource("/org/example/helofy/styles/defaultImage.png").toExternalForm()));
        }
        Rounded.applyRoundedClip(userImage, 10.0);
    }


    private void configureMusicPlayer() {
        musicPlayer.setOnSongChanged(song -> {
            Platform.runLater(() -> {
                if (song != null) {
                    updateSongName(song.getTitle());
                    songArtist.setText(musicPlayer.getCurrentPlaylistName());
                    loadSongCover(song);
                    lblTiempoTranscurrido.setText("0:00");
                    lblTiempoRestante.setText("-0:00");
                    selectCurrentSongInListView(song);
                } else {
                    updateSongName("No hay canción en reproducción");
                    songArtist.setText("Artista desconocido");
                    loadDefaultCover();
                    duracionTotalSegundos = 0;
                    progressSlider.setMax(1);
                    lblTiempoTranscurrido.setText("0:00");
                    lblTiempoRestante.setText("-0:00");
                }
            });
        });

        musicPlayer.setOnDurationChanged(duracion -> {
            Platform.runLater(() -> {
                duracionTotalSegundos = duracion;
                progressSlider.setMax(duracionTotalSegundos);
                lblTiempoRestante.setText("-" + formatearTiempo(duracionTotalSegundos));
            });
        });

        musicPlayer.setOnProgressChanged(progress -> {
            Platform.runLater(() -> {
                if (!isDraggingProgress && duracionTotalSegundos > 0) {
                    double tiempoActual = progress * duracionTotalSegundos;
                    if (tiempoActual > duracionTotalSegundos) tiempoActual = duracionTotalSegundos;
                    progressSlider.setValue(tiempoActual);
                    lblTiempoTranscurrido.setText(formatearTiempo(tiempoActual));
                    lblTiempoRestante.setText("-" + formatearTiempo(duracionTotalSegundos - tiempoActual));
                }
            });
        });

        musicPlayer.setOnSongFinished(() -> Platform.runLater(musicPlayer::nextSong));
        musicPlayer.setOnPlayingStatusChanged(isPlaying ->
                Platform.runLater(() -> playPauseButton.setText(isPlaying ? "⏸" : "▶"))
        );
    }

    private void updateSongName(String text) {
        songName.setText(text);
        setupSongNameMarquee();
    }

    private void setupSongNameMarquee() {
        Platform.runLater(() -> {
            // Desactivar puntos suspensivos y wrap
            songName.setEllipsisString("");
            songName.setTextOverrun(OverrunStyle.CLIP);
            songName.setWrapText(false);

            // Parar animación anterior y resetear posición
            if (marqueeAnimation != null) {
                marqueeAnimation.stop();
                marqueeAnimation = null;
                songName.setTranslateX(0);
            }

            // Forzar cálculo del tamaño real del texto y contenedor
            songName.applyCss();
            songName.layout();
            songNameContainer.applyCss();
            songNameContainer.layout();

            double labelWidth = songName.getWidth();
            double containerWidth = songNameContainer.getWidth();

            // Crear clip para limitar visibilidad dentro del contenedor
            Rectangle clip = new Rectangle(containerWidth, songNameContainer.getHeight());
            songNameContainer.setClip(clip);

            // Si el texto es más ancho que el contenedor, creamos la animación
            if (labelWidth > containerWidth) {
                double distance = labelWidth - containerWidth;

                marqueeAnimation = new TranslateTransition(Duration.seconds(8), songName);
                marqueeAnimation.setFromX(0);
                marqueeAnimation.setToX(-distance);
                marqueeAnimation.setCycleCount(Animation.INDEFINITE);
                marqueeAnimation.setAutoReverse(true);
                marqueeAnimation.play();
            }
        });
    }


    private void setupControls() {
        volumeSlider.valueProperty().addListener((obs, oldVal, newVal) -> musicPlayer.setVolume(newVal.doubleValue()));

        progressSlider.setOnMousePressed(e -> isDraggingProgress = true);

        progressSlider.setOnMouseDragged(e -> {
            if (musicPlayer.getCurrentSong() != null) {
                double valor = progressSlider.getValue();
                lblTiempoTranscurrido.setText(formatearTiempo(valor));
                lblTiempoRestante.setText("-" + formatearTiempo(duracionTotalSegundos - valor));
                musicPlayer.seek(valor / duracionTotalSegundos);
            }
        });

        progressSlider.setOnMouseReleased(e -> isDraggingProgress = false);

        playPauseButton.setOnAction(e -> togglePlayback());
        previousButton.setOnAction(e -> previousTrack());
        nextButton.setOnAction(e -> nextTrack());
        shuffleButton.setOnAction(e -> handleShuffle());
    }

    private void setupVolumePersistente() {
        volumeSlider.setValue(musicPlayer.getVolume());
        Rounded.applyRoundedClip(songImage, 10.0);
    }

    public void setCenterContent(String fxmlPath) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource(fxmlPath));
            Parent content = loader.load();

            Object controller = loader.getController();
            if (controller instanceof LibraryViewController) {
                ((LibraryViewController) controller).setMainController(this);
            } else if (controller instanceof SuperPlaylistController) {
                ((SuperPlaylistController) controller).setMainController(this);
            }

            contentArea.getChildren().setAll(content);
        } catch (IOException e) {
            showError("Error al cargar vista", e.getMessage());
        }
    }

    public void loadPlaylistView(Playlist playlist) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/org/example/helofy/views/PlaylistView.fxml"));
            Parent view = loader.load();

            PlaylistViewController controller = loader.getController();
            controller.configurarPlaylist(playlist, musicPlayer);

            contentArea.getChildren().setAll(view);
            musicPlayer.setPlaylist(playlist);
        } catch (IOException e) {
            showError("Error al cargar playlist", e.getMessage());
        }
    }

    @FXML
    private void togglePlayback() {
        if (musicPlayer.getCurrentSong() == null) return;
        if (musicPlayer.isPlaying()) musicPlayer.pause();
        else musicPlayer.resume();
    }

    @FXML
    private void previousTrack() {
        musicPlayer.previousSong();
    }

    @FXML
    private void nextTrack() {
        musicPlayer.nextSong();
    }

    private void loadSongCover(Song song) {
        try {
            Image cover = new Image("file:" + song.getCoverPath());
            songImage.setImage(cover);
        } catch (Exception e) {
            loadDefaultCover();
        }
    }

    private void resetSongInfo() {
        updateSongName("Sin canción");
        songArtist.setText("Artista desconocido");
        loadDefaultCover();
    }

    private void loadDefaultCover() {
        try {
            Image defaultCover = new Image(
                    Objects.requireNonNull(getClass().getResource("/org/example/helofy/styles/default_cover.png")).toExternalForm()
            );
            songImage.setImage(defaultCover);
        } catch (Exception e) {
            System.err.println("Error cargando cover predeterminado");
        }
    }

    private void selectCurrentSongInListView(Song currentSong) {
        if (contentArea.getChildren().isEmpty()) return;

        Parent currentContent = (Parent) contentArea.getChildren().get(0);
        ListView<Song> listaCanciones = (ListView<Song>) currentContent.lookup("#listaCanciones");

        if (listaCanciones != null && currentSong != null) {
            for (int i = 0; i < listaCanciones.getItems().size(); i++) {
                Song song = listaCanciones.getItems().get(i);
                if (song.getFilePath().equals(currentSong.getFilePath())) {
                    int finalIndex = i;
                    Platform.runLater(() -> {
                        listaCanciones.getSelectionModel().select(finalIndex);
                        listaCanciones.scrollTo(finalIndex);
                    });
                    break;
                }
            }
        }
    }

    private String formatearTiempo(double segundos) {
        int mins = (int) segundos / 60;
        int segs = (int) segundos % 60;
        return String.format("%d:%02d", mins, segs);
    }

    @FXML
    private void handleShuffle() {
        musicPlayer.toggleShuffle();
        updateShuffleButton();
    }

    private void updateShuffleButton() {
        shuffleButton.setText(musicPlayer.isShuffle() ? "🔀" : "🔁");
        shuffleButton.setStyle(musicPlayer.isShuffle()
                ? "-fx-text-fill: #1DB954; -fx-font-weight: bold;"
                : "-fx-text-fill: white;");
    }

    public void onSongSelected(Song song) {
        musicPlayer.playSong(song);
    }

    private void showError(String title, String message) {
        Platform.runLater(() -> {
            Alert alert = new Alert(Alert.AlertType.ERROR);
            alert.setTitle(title);
            alert.setHeaderText(null);
            alert.setContentText(message);
            alert.showAndWait();
        });
    }

    @FXML
    private void handleLibraryClick() {
        setCenterContent("/org/example/helofy/views/LibraryView.fxml");
    }

    @FXML
    private void handleCreatePlaylistClick() {
        setCenterContent("/org/example/helofy/views/CreatePlaylistView.fxml");
    }

    @FXML
    private void handleEditPlaylistClick() {
        setCenterContent("/org/example/helofy/views/EditPlaylistView.fxml");
    }

    @FXML
    private void handleSuperPlayListlick() {
        setCenterContent("/org/example/helofy/views/SuperPlayListView.fxml");
    }

    @FXML
    private void handleUserClick() {
        setCenterContent("/org/example/helofy/views/usuario/PerfilUsuario.fxml");
    }

    @FXML
    private void handleExitClick() {
        Platform.exit();
    }

    @FXML
    private void handleMinimizeClick() {
        Stage stage = (Stage) header.getScene().getWindow();
        stage.setIconified(true);
    }
}
